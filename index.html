<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Acta Express</title>
  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="stylesheet" href="./styles.css" />
  <meta name="theme-color" content="#0ea5e9" />
  <!-- Tailwind (ligero v√≠a CDN para prototipo) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.2.0/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-slate-50 text-slate-800">
  <header class="p-4 bg-sky-600 text-white shadow">
    <h1 class="text-xl font-semibold">Acta Express</h1>
    <p class="text-sm opacity-90">Visita de fidelizaci√≥n ‚Äì Firma en sitio ‚Äì PDF ‚Äì Excel maestro</p>
  </header>

  <main class="p-4 space-y-6 max-w-3xl mx-auto">
    <!-- Aviso PWA / offline -->
    <div id="pwaHint" class="hidden bg-amber-50 border border-amber-200 p-3 rounded text-amber-700 text-sm"></div>

    <!-- Config r√°pida -->
    <section class="card">
      <h2 class="card-title">Configuraci√≥n</h2>
      <div class="grid gap-3 md:grid-cols-2">
        <div>
          <label class="lbl">Mi nombre (Ejecutivo)</label>
          <input id="cfgEjecutivo" class="inp" placeholder="Tu nombre" />
        </div>
        <div>
          <label class="lbl">Mi correo (CC)</label>
          <input id="cfgCorreo" class="inp" placeholder="tucorreo@empresa.com" />
        </div>
        <div class="md:col-span-2 flex items-center gap-2">
          <input id="cfgGeo" type="checkbox" class="accent-sky-600" />
          <label for="cfgGeo" class="text-sm">Incluir ubicaci√≥n (geo) en las actas</label>
        </div>
      </div>
      <div class="mt-3 flex flex-wrap gap-2">
        <button id="btnGuardarCfg" class="btn">Guardar configuraci√≥n</button>
        <button id="btnElegirExcel" class="btn btn-outline" title="Opci√≥n A ‚Äì Android/Chrome">Elegir/crear Excel maestro</button>
        <button id="btnLimpiarExcelHandle" class="btn btn-ghost">Olvidar Excel maestro</button>
      </div>
      <p id="excelEstado" class="text-xs text-slate-500 mt-2"></p>
    </section>

    <!-- Formulario Express -->
    <section class="card">
      <h2 class="card-title">Nueva Acta de Visita</h2>
      
      <!-- Datos del Ejecutivo y Ubicaci√≥n -->
      <div class="mt-3">
        <h3 class="text-sm font-semibold text-slate-600 mb-2">üìç Datos del Ejecutivo y Ubicaci√≥n</h3>
        <div class="grid gap-3 md:grid-cols-2">
          <div>
            <label class="lbl">Zona</label>
            <input id="zona" class="inp" placeholder="Ej: Norte, Sur, Centro" />
          </div>
          <div>
            <label class="lbl">Barrio</label>
            <input id="barrio" class="inp" placeholder="Nombre del barrio" />
          </div>
          <div class="md:col-span-2">
            <label class="lbl">Direcci√≥n</label>
            <input id="direccion" class="inp" placeholder="Direcci√≥n completa" />
          </div>
        </div>
      </div>

      <!-- Datos del Cliente/Negocio -->
      <div class="mt-4">
        <h3 class="text-sm font-semibold text-slate-600 mb-2">üè¢ Datos del Cliente/Negocio</h3>
        <div class="grid gap-3 md:grid-cols-2">
          <div>
            <label class="lbl">N√∫mero de Contrato</label>
            <input id="numeroContrato" class="inp" placeholder="N√∫mero de contrato" />
          </div>
          <div>
            <label class="lbl">NIT</label>
            <input id="cliNit" class="inp" placeholder="NIT del cliente" />
          </div>
          <div>
            <label class="lbl">Actividad Econ√≥mica</label>
            <input id="actividadEconomica" class="inp" placeholder="Ej: Comercio, Manufactura" />
          </div>
          <div>
            <label class="lbl">Exenci√≥n de Contribuci√≥n</label>
            <select id="exencionContribucion" class="inp">
              <option value="">Seleccione...</option>
              <option value="S√≠">S√≠</option>
              <option value="No">No</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Datos Persona Encargada -->
      <div class="mt-4">
        <h3 class="text-sm font-semibold text-slate-600 mb-2">üë§ Datos de la Persona Encargada</h3>
        <div class="grid gap-3 md:grid-cols-2">
          <div>
            <label class="lbl">Contacto (Nombre)</label>
            <input id="contactoNombre" class="inp" placeholder="Nombre del contacto" />
          </div>
          <div>
            <label class="lbl">Cargo</label>
            <input id="contactoCargo" class="inp" placeholder="Cargo" />
          </div>
          <div>
            <label class="lbl">Correo Electr√≥nico</label>
            <input id="contactoCorreo" class="inp" type="email" placeholder="correo@ejemplo.com" />
          </div>
          <div>
            <label class="lbl">Celular</label>
            <input id="contactoCelular" class="inp" type="tel" placeholder="N√∫mero de celular" />
          </div>
        </div>
      </div>

      <!-- Temas a Tratar -->
      <div class="mt-4">
        <h3 class="text-sm font-semibold text-slate-600 mb-2">‚úÖ Temas Tratados con el Cliente</h3>
        <div class="space-y-3">
          <div>
            <label class="flex items-center gap-2 text-sm mb-1">
              <input type="checkbox" id="temaEnergiaEficiente" class="accent-sky-600" />
              <span>Energ√≠a eficiente</span>
            </label>
            <textarea id="descEnergiaEficiente" class="inp text-sm" rows="2" placeholder="Describe lo tratado sobre energ√≠a eficiente..." disabled></textarea>
          </div>
          <div>
            <label class="flex items-center gap-2 text-sm mb-1">
              <input type="checkbox" id="temaConexionEmcali" class="accent-sky-600" />
              <span>Conexi√≥n directa con Emcali</span>
            </label>
            <textarea id="descConexionEmcali" class="inp text-sm" rows="2" placeholder="Describe lo tratado sobre conexi√≥n directa..." disabled></textarea>
          </div>
          <div>
            <label class="flex items-center gap-2 text-sm mb-1">
              <input type="checkbox" id="temaEtiquetaRetiq" class="accent-sky-600" />
              <span>Etiqueta RETIQ</span>
            </label>
            <textarea id="descEtiquetaRetiq" class="inp text-sm" rows="2" placeholder="Describe lo tratado sobre etiqueta RETIQ..." disabled></textarea>
          </div>
          <div>
            <label class="flex items-center gap-2 text-sm mb-1">
              <input type="checkbox" id="temaAhorroEnergia" class="accent-sky-600" />
              <span>Ahorro de energ√≠a</span>
            </label>
            <textarea id="descAhorroEnergia" class="inp text-sm" rows="2" placeholder="Describe lo tratado sobre ahorro de energ√≠a..." disabled></textarea>
          </div>
          <div>
            <label class="flex items-center gap-2 text-sm mb-1">
              <input type="checkbox" id="temaConsumoEnergia" class="accent-sky-600" />
              <span>Consumo de energ√≠a</span>
            </label>
            <textarea id="descConsumoEnergia" class="inp text-sm" rows="2" placeholder="Describe lo tratado sobre consumo de energ√≠a..." disabled></textarea>
          </div>
        </div>
      </div>

      <!-- Incidencias -->
      <div class="mt-4">
        <h3 class="text-sm font-semibold text-slate-600 mb-2">‚ö†Ô∏è Incidencias</h3>
        <div class="space-y-3">
          <div class="grid gap-3 md:grid-cols-3 items-end">
            <div class="md:col-span-2">
              <label class="lbl">¬øHa tenido variaciones y fluctuaciones?</label>
              <select id="incVariaciones" class="inp">
                <option value="">Seleccione...</option>
                <option value="No">No</option>
                <option value="S√≠">S√≠</option>
              </select>
            </div>
            <div>
              <label class="lbl">¬øCu√°ntas?</label>
              <input id="incVariacionesCant" class="inp" type="number" min="0" placeholder="0" disabled />
            </div>
          </div>
          <div class="grid gap-3 md:grid-cols-3 items-end">
            <div class="md:col-span-2">
              <label class="lbl">¬øHa tenido cortes de suministro de energ√≠a?</label>
              <select id="incCortes" class="inp">
                <option value="">Seleccione...</option>
                <option value="No">No</option>
                <option value="S√≠">S√≠</option>
              </select>
            </div>
            <div>
              <label class="lbl">¬øCu√°ntas?</label>
              <input id="incCortesCant" class="inp" type="number" min="0" placeholder="0" disabled />
            </div>
          </div>
        </div>
      </div>

      <!-- Observaciones -->
      <div class="mt-4">
        <label class="lbl">Observaciones Generales</label>
        <textarea id="observaciones" class="inp" rows="4" placeholder="Observaciones adicionales de la visita..."></textarea>
      </div>

      <div class="mt-4 flex items-center gap-2">
        <input id="consent" type="checkbox" class="accent-sky-600" />
        <label for="consent" class="text-sm">El cliente autoriza el registro y env√≠o del acta</label>
      </div>

      <div class="mt-6">
        <h3 class="text-sm font-semibold text-slate-600 mb-2">Firma del cliente</h3>
        <div class="bg-white border rounded-lg p-3">
          <div class="flex gap-2 items-center text-xs text-slate-500 mb-2">
            <span>Firme con el dedo dentro del recuadro</span>
            <button id="btnLimpiarFirma" class="ml-auto btn btn-ghost btn-xs">Limpiar</button>
          </div>
          <div class="border rounded overflow-hidden">
            <canvas id="pad" style="width:100%; height:240px; display:block; touch-action:none;"></canvas>
          </div>
          <div class="mt-3">
            <label class="lbl">Nombre del firmante</label>
            <input id="firmanteNombre" class="inp" />
          </div>
        </div>
      </div>

      <div class="mt-6 flex flex-wrap gap-2">
        <button id="btnGenerarPDF" class="btn">Generar PDF</button>
        <button id="btnCompartir" class="btn btn-outline">Compartir (Outlook)</button>
        <button id="btnDescargarPDF" class="btn btn-ghost">üì• Descargar PDF</button>
        <button id="btnGuardarExcel" class="btn btn-ghost">Actualizar Excel maestro</button>
      </div>
      <p id="estado" class="text-xs text-slate-500 mt-2"></p>
    </section>

    <!-- Historial -->
    <section class="card">
      <h2 class="card-title">Historial</h2>
      <div class="mb-3">
        <a href="./dashboard.html" class="btn btn-outline btn-sm">üìä Ver Dashboard y Reportes</a>
      </div>
      <div id="historial" class="space-y-2 text-sm"></div>
    </section>
  </main>

  <script>
    // Habilitar/deshabilitar campos seg√∫n selecci√≥n
    document.addEventListener('DOMContentLoaded', ()=>{
      // Incidencias
      const incVariaciones = document.getElementById('incVariaciones');
      const incVariacionesCant = document.getElementById('incVariacionesCant');
      const incCortes = document.getElementById('incCortes');
      const incCortesCant = document.getElementById('incCortesCant');
      
      incVariaciones.addEventListener('change', ()=>{
        incVariacionesCant.disabled = incVariaciones.value !== 'S√≠';
        if(incVariaciones.value !== 'S√≠') incVariacionesCant.value = '';
      });
      
      incCortes.addEventListener('change', ()=>{
        incCortesCant.disabled = incCortes.value !== 'S√≠';
        if(incCortes.value !== 'S√≠') incCortesCant.value = '';
      });

      // Temas tratados
      const temas = [
        { checkbox: 'temaEnergiaEficiente', textarea: 'descEnergiaEficiente' },
        { checkbox: 'temaConexionEmcali', textarea: 'descConexionEmcali' },
        { checkbox: 'temaEtiquetaRetiq', textarea: 'descEtiquetaRetiq' },
        { checkbox: 'temaAhorroEnergia', textarea: 'descAhorroEnergia' },
        { checkbox: 'temaConsumoEnergia', textarea: 'descConsumoEnergia' }
      ];

      temas.forEach(tema => {
        const checkbox = document.getElementById(tema.checkbox);
        const textarea = document.getElementById(tema.textarea);
        
        checkbox.addEventListener('change', ()=>{
          textarea.disabled = !checkbox.checked;
          if(!checkbox.checked) textarea.value = '';
        });
      });
    });
  </script>
  <script type="module" src="./app.js"></script>
</body>
</html>



{
  "name": "Acta Express",
  "short_name": "ActaExpress",
  "start_url": "./index.html",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#0ea5e9",
  "icons": [
    { "src": "./icon-192.png", "sizes": "192x192", "type": "image/png" },
    { "src": "./icon-512.png", "sizes": "512x512", "type": "image/png" }
  ],
  "description": "Aplicaci√≥n PWA para generar actas de visita con firma electr√≥nica"
}


# Acta Express - Fidelizaci√≥n Emcali (PWA 100% local)

**Aplicaci√≥n PWA para generar actas de visita de fidelizaci√≥n con firma electr√≥nica, PDF y Excel maestro**

---

## üìã Descripci√≥n

**Acta Express** es una Progressive Web App (PWA) dise√±ada espec√≠ficamente para ejecutivos de campo de Emcali que necesitan documentar visitas de fidelizaci√≥n con clientes. La aplicaci√≥n incluye:

- ‚úÖ Formulario estructurado para visitas de fidelizaci√≥n
- ‚úÖ Captura de datos del ejecutivo y ubicaci√≥n (zona, barrio, direcci√≥n)
- ‚úÖ Datos completos del cliente/negocio (contrato, NIT, actividad econ√≥mica)
- ‚úÖ Registro de temas tratados con el cliente (energ√≠a eficiente, RETIQ, etc.)
- ‚úÖ Registro de incidencias (variaciones, cortes de suministro)
- ‚úÖ Firma manuscrita en pantalla (touch/stylus)
- ‚úÖ Generaci√≥n de PDF profesional con QR y hash SHA-256
- ‚úÖ Compartir directo a Outlook/WhatsApp
- ‚úÖ Historial local en IndexedDB
- ‚úÖ Exportaci√≥n a Excel maestro con 32 columnas
- ‚úÖ Modo offline (una vez instalada como PWA)
- ‚úÖ Geolocalizaci√≥n opcional

---

## üóÇÔ∏è Estructura de archivos

```
acta-express/
‚îú‚îÄ index.html              # UI principal
‚îú‚îÄ app.js                  # L√≥gica completa
‚îú‚îÄ dashboard.html          # Dashboard de an√°lisis
‚îú‚îÄ dashboard.js            # L√≥gica del dashboard
‚îú‚îÄ styles.css              # Estilos m√≥viles
‚îú‚îÄ manifest.webmanifest    # Configuraci√≥n PWA
‚îú‚îÄ service-worker.js       # Cache offline
‚îú‚îÄ icon-192.png            # √çcono PWA 192x192
‚îú‚îÄ icon-512.png            # √çcono PWA 512x512
‚îú‚îÄ Actas_Master (3).xlsx   # Ejemplo de Excel maestro
‚îî‚îÄ README.md               # Este archivo
```

---

## üöÄ Instalaci√≥n r√°pida

### Opci√≥n 1: Servidor local (localhost)

```powershell
# En PowerShell, desde la carpeta acta-express:
python -m http.server 8000
```

Luego abre en tu navegador:
```
http://localhost:8000
```

### Opci√≥n 2: Hosting est√°tico (recomendado para PWA completa)

Sube los archivos a:
- **GitHub Pages** (gratuito, HTTPS autom√°tico)
- **Netlify** (gratuito, HTTPS, drag & drop)
- **Vercel** (gratuito, HTTPS)
- Tu servidor con HTTPS

> ‚ö†Ô∏è **Importante:** Para que funcione como PWA instalable y offline, necesitas **HTTPS** o **localhost**.

---

## üì± Uso en Android (instalaci√≥n PWA)

1. Abre la URL en **Chrome para Android**
2. Toca el men√∫ (‚ãÆ) ‚Üí **Agregar a pantalla de inicio**
3. La app se instalar√° como aplicaci√≥n nativa
4. √Åbrela desde el launcher de Android

---

## üéØ Gu√≠a de uso

### 1Ô∏è‚É£ Configuraci√≥n inicial

1. Abre la app
2. En la secci√≥n **Configuraci√≥n**:
   - Ingresa tu nombre (Ejecutivo)
   - Ingresa tu correo corporativo
   - (Opcional) Activa **geolocalizaci√≥n** para incluir coordenadas GPS
3. Clic en **Guardar configuraci√≥n**

### 2Ô∏è‚É£ Configurar Excel maestro (opcional)

**Opci√≥n A - Android/Chrome con File System Access:**
1. Clic en **Elegir/crear Excel maestro**
2. Selecciona o crea el archivo `Actas_Master.xlsx`
3. La app podr√° agregar registros directamente al archivo

**Opci√≥n B - Modo regenerado (todos los navegadores):**
- Si no configuras el Excel, cada vez que guardes se descargar√° un archivo completo actualizado
- Simplemente sobrescribe el anterior con el mismo nombre

### 3Ô∏è‚É£ Crear una nueva acta

1. **Completa los datos del ejecutivo y ubicaci√≥n:**
   - Zona (Norte, Sur, Centro, etc.)
   - Barrio
   - Direcci√≥n completa

2. **Datos del Cliente/Negocio:**
   - N√∫mero de Contrato
   - NIT
   - Actividad Econ√≥mica
   - Exenci√≥n de Contribuci√≥n (S√≠/No)

3. **Datos de la Persona Encargada:**
   - Nombre del contacto
   - Cargo
   - Correo electr√≥nico
   - Celular

4. **Temas Tratados con el Cliente:**
   - Marca los temas que se trataron durante la visita y describe cada uno:
     - ‚òë Energ√≠a eficiente ‚Üí (campo de texto para descripci√≥n)
     - ‚òë Conexi√≥n directa con Emcali ‚Üí (campo de texto para descripci√≥n)
     - ‚òë Etiqueta RETIQ ‚Üí (campo de texto para descripci√≥n)
     - ‚òë Ahorro de energ√≠a ‚Üí (campo de texto para descripci√≥n)
     - ‚òë Consumo de energ√≠a ‚Üí (campo de texto para descripci√≥n)

5. **Incidencias:**
   - ¬øHa tenido variaciones y fluctuaciones? (S√≠/No)
     - Si es S√≠, indica cu√°ntas
   - ¬øHa tenido cortes de suministro de energ√≠a? (S√≠/No)
     - Si es S√≠, indica cu√°ntas

6. **Observaciones Generales:**
   - Describe cualquier observaci√≥n adicional de la visita

7. **Firma del cliente:**
   - El cliente firma con el dedo en el recuadro blanco
   - Si se equivoca, clic en **Limpiar**
   - Ingresa nombre del firmante

8. Marca el **checkbox de consentimiento**

9. Clic en **Generar PDF**

### 4Ô∏è‚É£ Compartir el acta

**Opci√≥n 1 - Descarga autom√°tica:**
1. Clic en **Compartir (Outlook)**
2. El PDF se descarga autom√°ticamente
3. Adj√∫ntalo manualmente en tu correo

**Opci√≥n 2 - Web Share (bonus):**
- Si tu dispositivo lo soporta, se abrir√° el men√∫ de compartir nativo
- Selecciona la app (Outlook, Gmail, WhatsApp, etc.)

### 5Ô∏è‚É£ Actualizar Excel maestro

**Guardar todas las actas:**
- Clic en **Actualizar Excel maestro**
- Se generar√°/actualizar√° el archivo con la hoja **Actas** (37 columnas)

**Guardar una sola acta:**
- En el **Historial**, clic en **A√±adir a Excel** junto a la acta deseada

### 6Ô∏è‚É£ Consultar historial

- Todas las actas se guardan en el dispositivo (IndexedDB)
- Desde el historial puedes:
  - **Compartir** cualquier acta anterior
  - **A√±adir a Excel** actas individuales

---

## üìä Estructura del Excel maestro

### Hoja "Actas" (37 columnas)

| # | Columna | Descripci√≥n |
|---|---------|-------------|
| 1 | id_acta | ID √∫nico (ej: AX-20251011203045) |
| 2 | fecha_local | Fecha/hora local del dispositivo |
| 3 | fecha_utc | Fecha/hora UTC (ISO 8601) |
| 4 | ejecutivo_nombre | Nombre del ejecutivo |
| 5 | ejecutivo_correo | Correo del ejecutivo |
| 6 | zona | Zona de la visita |
| 7 | barrio | Barrio |
| 8 | direccion | Direcci√≥n completa |
| 9 | numero_contrato | N√∫mero de contrato del cliente |
| 10 | nit | NIT del cliente |
| 11 | actividad_economica | Actividad econ√≥mica del negocio |
| 12 | exencion_contribucion | Exenci√≥n de contribuci√≥n (S√≠/No) |
| 13 | contacto_nombre | Nombre de la persona encargada |
| 14 | contacto_cargo | Cargo del contacto |
| 15 | contacto_correo | Correo del contacto |
| 16 | contacto_celular | Celular del contacto |
| 17 | tema_energia_eficiente | Se trat√≥ energ√≠a eficiente (S√≠/No) |
| 18 | desc_energia_eficiente | Descripci√≥n del tema energ√≠a eficiente |
| 19 | tema_conexion_emcali | Se trat√≥ conexi√≥n con Emcali (S√≠/No) |
| 20 | desc_conexion_emcali | Descripci√≥n del tema conexi√≥n Emcali |
| 21 | tema_etiqueta_retiq | Se trat√≥ etiqueta RETIQ (S√≠/No) |
| 22 | desc_etiqueta_retiq | Descripci√≥n del tema etiqueta RETIQ |
| 23 | tema_ahorro_energia | Se trat√≥ ahorro de energ√≠a (S√≠/No) |
| 24 | desc_ahorro_energia | Descripci√≥n del tema ahorro de energ√≠a |
| 25 | tema_consumo_energia | Se trat√≥ consumo de energ√≠a (S√≠/No) |
| 26 | desc_consumo_energia | Descripci√≥n del tema consumo de energ√≠a |
| 27 | incidencias_variaciones | Tuvo variaciones (S√≠/No/vac√≠o) |
| 28 | incidencias_variaciones_cant | Cantidad de variaciones |
| 29 | incidencias_cortes | Tuvo cortes (S√≠/No/vac√≠o) |
| 30 | incidencias_cortes_cant | Cantidad de cortes |
| 31 | observaciones | Observaciones generales |
| 32 | firmante_nombre | Nombre del firmante |
| 33 | geo_lat | Latitud (si geo est√° activo) |
| 34 | geo_lng | Longitud (si geo est√° activo) |
| 35 | hash_sha256 | Hash SHA-256 de verificaci√≥n |
| 36 | pdf_filename | Nombre del archivo PDF |

---

## üîê Seguridad y validaci√≥n

### Hash SHA-256
Cada acta incluye un hash criptogr√°fico que:
- Se calcula sobre todos los datos (excepto la imagen de firma)
- Aparece en el PDF
- Se incluye en el c√≥digo QR
- Permite verificar que el documento no fue alterado

### C√≥digo QR
Contiene:
```json
{
  "id": "AX-20251011203045",
  "hash": "base64_hash_sha256"
}
```

### Firma manuscrita
- Se captura como imagen PNG (base64)
- Se incluye en el PDF y en el historial
- No sustituye firma electr√≥nica avanzada certificada

---

## üõ†Ô∏è Personalizaci√≥n

### Modificar temas a tratar
Edita en `index.html` (l√≠neas ~127-150) para agregar o modificar los checkboxes:
```html
<label class="flex items-center gap-2 text-sm">
  <input type="checkbox" id="temaPersonalizado" class="accent-sky-600" />
  <span>Tu tema personalizado</span>
</label>
```

Luego actualiza `app.js` en la funci√≥n `buildActaJSON()` para capturar el nuevo campo.

### Agregar logo al PDF
Edita `app.js`, en la funci√≥n `buildPDF()`, despu√©s de la l√≠nea del encabezado (l√≠nea ~297):
```javascript
// Despu√©s de doc.text('ACTA DE VISITA...', L, T);
const logoImg = 'data:image/png;base64,TU_LOGO_BASE64...';
doc.addImage(logoImg, 'PNG', 420, 30, 100, 40); // Ajusta posici√≥n/tama√±o
```

### Cambiar colores
Edita `styles.css`:
```css
:root{ 
  --sky:#0ea5e9;  /* Color principal (azul cielo) */
  --ink:#0f172a;  /* Color texto oscuro */
}
```

O en `manifest.webmanifest`:
```json
"theme_color": "#0ea5e9"  /* Color de barra en Android */
```

---

## üß™ Requisitos t√©cnicos

### Navegador recomendado
- **Chrome/Edge** (Android/Desktop): Soporte completo
- **Safari** (iOS): Funciona, pero File System Access limitado
- **Firefox**: Funciona, sin File System Access

### Funcionalidades por navegador

| Funci√≥n | Chrome Android | Safari iOS | Edge Desktop |
|---------|:--------------:|:----------:|:------------:|
| Formulario | ‚úÖ | ‚úÖ | ‚úÖ |
| Firma t√°ctil | ‚úÖ | ‚úÖ | ‚úÖ |
| Generar PDF | ‚úÖ | ‚úÖ | ‚úÖ |
| Web Share API | ‚úÖ | ‚úÖ | ‚ö†Ô∏è |
| Instalar PWA | ‚úÖ | ‚úÖ | ‚úÖ |
| Offline (SW) | ‚úÖ | ‚ö†Ô∏è | ‚úÖ |
| Excel Append | ‚úÖ | ‚ùå | ‚úÖ |
| Excel Regenerado | ‚úÖ | ‚úÖ | ‚úÖ |

‚úÖ Completo | ‚ö†Ô∏è Parcial | ‚ùå No soportado

---

## üì¶ Dependencias (CDN)

La app usa estas librer√≠as v√≠a CDN (no requiere npm/instalaci√≥n):

- **Tailwind CSS** - Estilos utility-first
- **Signature Pad** - Captura de firma manuscrita
- **jsPDF** - Generaci√≥n de PDF en cliente
- **QRCode.js** - C√≥digos QR
- **SheetJS (xlsx)** - Lectura/escritura Excel

> üí° Si quieres que funcione 100% offline sin internet, descarga las librer√≠as localmente y actualiza las rutas en `index.html` y `service-worker.js`.

---

## üêõ Soluci√≥n de problemas

### "La firma no se captura bien"
- Aseg√∫rate de firmar dentro del recuadro blanco
- Usa el dedo o stylus, no el cursor del mouse en mobile
- Si la l√≠nea es muy delgada, aumenta el grosor en `app.js`:
  ```javascript
  state.firmaPad = new SignaturePad(canvas, { 
    backgroundColor: 'rgb(255,255,255)',
    penColor: 'rgb(0,0,0)',
    minWidth: 1.5,
    maxWidth: 3
  });
  ```

### "No se instala como PWA"
- Verifica que est√©s usando HTTPS o localhost
- En Chrome Android: Men√∫ ‚Üí Agregar a pantalla de inicio
- Aseg√∫rate de tener los iconos en `/assets/`

### "El Excel no se actualiza directamente"
- El modo "Append directo" solo funciona en Chrome/Edge con File System Access API
- En otros casos, usa el modo "regenerado" (descarga y sobrescribe)

### "El PDF no se comparte"
- Si Web Share no funciona, el PDF se descarga
- Adj√∫ntalo manualmente desde tu app de correo

### "No funciona offline"
- Primero debes acceder online para que se instale el Service Worker
- Verifica en Chrome DevTools ‚Üí Application ‚Üí Service Workers
- Comprueba que las rutas en `service-worker.js` sean correctas

---

## üìå Notas legales

### Acuse de recibido simple
Esta soluci√≥n genera **acuse de recibido documental** con:
- Firma manuscrita digital
- Hash SHA-256 de verificaci√≥n
- Timestamp local y UTC
- C√≥digo QR con datos de verificaci√≥n

### No es firma electr√≥nica avanzada
Este sistema **NO sustituye** servicios de firma electr√≥nica avanzada/cualificada seg√∫n normativas locales (ej: eIDAS en UE, Ley 527 en Colombia).

Para firmas con validez legal plena, integra servicios certificados como:
- DocuSign, Adobe Sign, SignNow
- Certic√°mara (Colombia), EDICOM, etc.

### Privacidad y almacenamiento
- Todos los datos se almacenan **localmente** en el dispositivo (IndexedDB)
- No hay servidor backend ni transmisi√≥n de datos
- El usuario es responsable de la seguridad del dispositivo

---

## üö¶ Pr√≥ximos pasos sugeridos

1. **Agregar tus iconos** personalizados (192x192 y 512x512 px) reemplazando los existentes
2. **Personalizar el logo de Emcali** en el PDF
3. **Ajustar los temas a tratar** seg√∫n necesidades espec√≠ficas
4. **Probar en Android** con casos reales de visitas de fidelizaci√≥n
5. **Subir a GitHub Pages o Netlify** para HTTPS y acceso remoto
6. **Capacitar al equipo** en el uso de la app
7. **Integrar con dashboard** para an√°lisis de datos (archivo dashboard.html incluido)

---

## üìû Soporte

Para personalizaciones adicionales o integraci√≥n con sistemas empresariales:
- Bases de datos backend (Firebase, Supabase)
- API REST para sincronizaci√≥n
- Firma electr√≥nica certificada
- Personalizaci√≥n de plantillas PDF
- M√≥dulos adicionales (fotos, audios, geofencing)

---

## üìÑ Licencia

Este c√≥digo es un prototipo funcional. √ösalo y modif√≠calo seg√∫n tus necesidades.

---

**¬°Listo para capturar actas en campo! üöÄ**


const CACHE = 'acta-express-v1';
const ASSETS = [
  './',
  './index.html',
  './app.js',
  './dashboard.html',
  './dashboard.js',
  './styles.css',
  './manifest.webmanifest',
  './icon-192.png',
  './icon-512.png'
];

// CDNs se cachean bajo demanda
const CDN_URLS = [
  'https://cdn.tailwindcss.com',
  'https://cdn.jsdelivr.net/npm/signature_pad@4.2.0/dist/signature_pad.umd.min.js',
  'https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js',
  'https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js',
  'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js',
  'https://cdn.jsdelivr.net/npm/chart.js'
];

self.addEventListener('install', (e)=>{
  e.waitUntil(
    caches.open(CACHE).then(c => {
      // Cachear assets locales primero
      return c.addAll(ASSETS);
    })
  );
  self.skipWaiting();
});

self.addEventListener('activate', (e)=>{
  e.waitUntil(
    caches.keys().then(keys => 
      Promise.all(keys.map(k => k !== CACHE && caches.delete(k)))
    )
  );
  return self.clients.claim();
});

self.addEventListener('fetch', (e)=>{
  const url = e.request.url;
  
  // Cache-first para assets locales
  if(url.includes(self.location.origin)){
    e.respondWith(
      caches.match(e.request).then(res => 
        res || fetch(e.request).then(fetchRes => {
          return caches.open(CACHE).then(cache => {
            cache.put(e.request, fetchRes.clone());
            return fetchRes;
          });
        }).catch(() => caches.match('./index.html'))
      )
    );
  }
  // Network-first para CDNs
  else {
    e.respondWith(
      fetch(e.request).then(fetchRes => {
        return caches.open(CACHE).then(cache => {
          cache.put(e.request, fetchRes.clone());
          return fetchRes;
        });
      }).catch(() => caches.match(e.request))
    );
  }
});


:root{ --sky:#0ea5e9; --ink:#0f172a; --muted:#64748b; }
body{ font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
.card{ background:#fff; border:1px solid #e2e8f0; border-radius:14px; padding:16px; box-shadow: 0 2px 8px rgba(2,6,23,0.04); }
.card-title{ font-size:1rem; font-weight:700; color:#0f172a; margin-bottom:10px; }
.lbl{ display:block; font-size:.8rem; color:#334155; margin-bottom:6px; }
.inp{ width:100%; background:#fff; border:1px solid #cbd5e1; border-radius:10px; padding:10px 12px; font-size:.95rem; }
.btn{ background:var(--sky); color:#fff; padding:10px 14px; border-radius:10px; font-weight:600; }
.btn:hover{ filter:brightness(0.95); }
.btn-outline{ background:#fff; color:var(--sky); border:1px solid var(--sky); }
.btn-ghost{ background:transparent; color:#0f172a; border:1px dashed #cbd5e1; }
.btn-xs{ padding:6px 8px; font-size:.8rem; }
.chip{ background:#f1f5f9; border:1px solid #e2e8f0; border-radius:999px; padding:6px 12px; font-size:.85rem; }
.chip:active{ transform:scale(.98); }


# Archivos de desarrollo
.DS_Store
Thumbs.db
*.log

# Archivos de usuario (Excel maestros locales)
Actas_Master*.xlsx

# Node modules si se agregan dependencias
node_modules/

# IDEs
.vscode/
.idea/
*.swp
*.swo


// app.js (ESM)
// Bloque 1: PWA ‚Äì formulario, firma, PDF, compartir, historial
// Bloque 2: Excel maestro (Append con File System Access cuando se pueda; regenerado si no)

imported();
async function imported(){ /* noop to hint module */ }

// ===== UTILIDADES B√ÅSICAS =====
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => [...document.querySelectorAll(sel)];
const sleep = (ms) => new Promise(r => setTimeout(r, ms));

// Estado en memoria
const state = {
  cfg: {
    ejecutivo: '',
    correo: '',
    geo: false,
  },
  excelHandle: null, // File System Access handle (opci√≥n A)
  firmaPad: null,
  firmaPng: null,
  geo: {lat:null,lng:null},
  ultimoPDFBlob: null,
  ultimoActa: null,
};

// IndexedDB para historial
let db; // IDBDatabase
const DB_NAME = 'acta_express_db';
const DB_STORE = 'actas';

init();

async function init(){
  hintPWA();
  await idbOpen();
  bindUI();
  await loadCfg();
  initSignaturePad();
  renderHistorial();
  if(state.cfg.geo){ getGeo(); }
  if('serviceWorker' in navigator){
    try{ await navigator.serviceWorker.register('./service-worker.js'); }catch{}
  }
}

function hintPWA(){
  const el = $('#pwaHint');
  if(!('serviceWorker' in navigator)){
    el.classList.remove('hidden');
    el.textContent = 'Sugerencia: para usar offline, publica estos archivos en un hosting est√°tico (HTTPS) y se instalar√° como PWA. Mientras tanto, la app funciona online.';
  }
}

// ===== IndexedDB =====
function idbOpen(){
  return new Promise((resolve, reject)=>{
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = (e)=>{
      const db = req.result;
      if(!db.objectStoreNames.contains(DB_STORE)){
        db.createObjectStore(DB_STORE, { keyPath: 'id' });
      }
    };
    req.onsuccess = ()=>{ db = req.result; resolve(); };
    req.onerror = ()=> reject(req.error);
  });
}

function idbPut(acta){
  return new Promise((resolve,reject)=>{
    const tx = db.transaction(DB_STORE,'readwrite');
    tx.objectStore(DB_STORE).put(acta);
    tx.oncomplete=()=>resolve();
    tx.onerror=()=>reject(tx.error);
  });
}

function idbAll(){
  return new Promise((resolve,reject)=>{
    const tx = db.transaction(DB_STORE,'readonly');
    const req = tx.objectStore(DB_STORE).getAll();
    req.onsuccess=()=>resolve(req.result||[]);
    req.onerror=()=>reject(req.error);
  });
}

// ===== Configuraci√≥n =====
async function loadCfg(){
  const raw = localStorage.getItem('cfg');
  if(raw){ state.cfg = JSON.parse(raw); }
  $('#cfgEjecutivo').value = state.cfg.ejecutivo||'';
  $('#cfgCorreo').value = state.cfg.correo||'';
  $('#cfgGeo').checked = !!state.cfg.geo;

  // Excel handle (si se guard√≥)
  const h = localStorage.getItem('excelHandle');
  if(h){
    try{
      state.excelHandle = await window.showOpenFilePicker({ // dummy to get permissions later
        types:[{description:'Excel', accept:{'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet':['.xlsx']}}],
        multiple:false
      });
    }catch{}
  }
  updateExcelEstado();
}

function saveCfg(){
  state.cfg.ejecutivo = $('#cfgEjecutivo').value.trim();
  state.cfg.correo = $('#cfgCorreo').value.trim();
  state.cfg.geo = $('#cfgGeo').checked;
  localStorage.setItem('cfg', JSON.stringify(state.cfg));
}

function bindUI(){
  $('#btnGuardarCfg').addEventListener('click', ()=>{ saveCfg(); toast('Configuraci√≥n guardada'); });
  $('#btnElegirExcel').addEventListener('click', chooseExcelMaster);
  $('#btnLimpiarExcelHandle').addEventListener('click', ()=>{ localStorage.removeItem('excelMasterName'); toast('Excel maestro olvidado'); updateExcelEstado(); });

  $('#btnLimpiarFirma').addEventListener('click', ()=> state.firmaPad.clear());
  $('#btnGenerarPDF').addEventListener('click', onGenerarPDF);
  $('#btnCompartir').addEventListener('click', onCompartir);
  $('#btnDescargarPDF').addEventListener('click', descargarPDF);
  $('#btnGuardarExcel').addEventListener('click', onGuardarExcelMaestro);
  
  // Agregar bot√≥n alternativo de descarga
  $('#btnCompartir').addEventListener('contextmenu', (e)=>{
    e.preventDefault();
    if(!state.ultimoPDFBlob){ toast('Primero genera el PDF'); return; }
    const filename = state.ultimoActa?.archivos?.pdf_filename || 'Acta.pdf';
    const file = new File([state.ultimoPDFBlob], filename, { type: 'application/pdf' });
    const url = URL.createObjectURL(file);
    const a = document.createElement('a');
    a.href = url; a.download = filename; a.click();
    URL.revokeObjectURL(url);
    toast('üì• PDF descargado (env√≠alo por correo manualmente)');
  });
}

function updateExcelEstado(){
  const el = $('#excelEstado');
  const name = localStorage.getItem('excelMasterName');
  el.textContent = name ? `Excel maestro configurado: ${name}` : 'Excel maestro no configurado (opci√≥n B: regenerado).';
}

async function chooseExcelMaster(){
  if(!window.showSaveFilePicker){ toast('Tu navegador no soporta acceso directo a archivos. Usaremos el modo "regenerado".'); return; }
  const handle = await window.showSaveFilePicker({
    suggestedName: 'Actas_Master.xlsx',
    types: [{description:'Excel', accept:{'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet':['.xlsx']}}]
  });
  localStorage.setItem('excelMasterName', handle.name || 'Actas_Master.xlsx');
  // Guardamos el handle en memoria de sesi√≥n (no persistente por seguridad)
  state.excelHandle = handle;
  updateExcelEstado();
  toast('Excel maestro establecido');
}

// ===== Geolocalizaci√≥n (opcional) =====
function getGeo(){
  if(!navigator.geolocation) return;
  navigator.geolocation.getCurrentPosition(pos=>{
    state.geo.lat = pos.coords.latitude;
    state.geo.lng = pos.coords.longitude;
  },()=>{}, { enableHighAccuracy:false, maximumAge:60000, timeout:5000 });
}

// ===== Firma =====
function initSignaturePad(){
  const canvas = $('#pad');
  resizeCanvas(canvas);
  window.addEventListener('resize', ()=> resizeCanvas(canvas));
  state.firmaPad = new SignaturePad(canvas, { backgroundColor: 'rgb(255,255,255)' });
}
function resizeCanvas(c){
  const ratio = Math.max(window.devicePixelRatio || 1, 1);
  c.width = c.offsetWidth * ratio;
  c.height = 240 * ratio;
  const ctx = c.getContext('2d');
  ctx.scale(ratio, ratio);
}

// ===== HASH con Web Crypto =====
async function sha256Base64(str){
  const enc = new TextEncoder().encode(str);
  const digest = await crypto.subtle.digest('SHA-256', enc);
  const bytes = new Uint8Array(digest);
  let bin = '';
  bytes.forEach(b => bin += String.fromCharCode(b));
  return btoa(bin);
}

// ===== Generar Acta + PDF =====
async function onGenerarPDF(){
  try{
    $('#estado').textContent = 'Generando PDF...';
    const acta = await buildActaJSON();
    const { blob, filename } = await buildPDF(acta);
    state.ultimoPDFBlob = blob;
    acta.archivos = { pdf_filename: filename };
    await idbPut(acta);
    state.ultimoActa = acta;
    $('#estado').textContent = `PDF listo: ${filename}`;
    renderHistorial();
    toast('PDF generado y guardado en historial');
  }catch(err){
    console.error(err);
    const mensaje = err.message || 'Error generando PDF';
    toast(mensaje);
    $('#estado').textContent = `‚ùå ${mensaje}`;
  }
}

async function buildActaJSON(){
  const now = new Date();
  const fecha_local = now.toLocaleString();
  const fecha_utc = now.toISOString();
  const id = 'AX-' + fecha_utc.replace(/[-:.TZ]/g,'').slice(0,14);

  if(state.firmaPad.isEmpty()) throw new Error('‚ö†Ô∏è Debe firmar en el recuadro antes de generar el PDF');
  const firmaPng = state.firmaPad.toDataURL('image/png');

  const base = {
    id,
    ejecutivo: {
      nombre: state.cfg.ejecutivo||'',
      correo: state.cfg.correo||'',
    },
    ubicacion: {
      zona: $('#zona').value.trim(),
      barrio: $('#barrio').value.trim(),
      direccion: $('#direccion').value.trim(),
    },
    cliente: {
      numeroContrato: $('#numeroContrato').value.trim(),
      nit: $('#cliNit').value.trim(),
      actividadEconomica: $('#actividadEconomica').value.trim(),
      exencionContribucion: $('#exencionContribucion').value.trim(),
    },
    contacto: {
      nombre: $('#contactoNombre').value.trim(),
      cargo: $('#contactoCargo').value.trim(),
      correo: $('#contactoCorreo').value.trim(),
      celular: $('#contactoCelular').value.trim(),
    },
    temasTratados: {
      energiaEficiente: $('#temaEnergiaEficiente').checked,
      descEnergiaEficiente: $('#descEnergiaEficiente').value.trim(),
      conexionEmcali: $('#temaConexionEmcali').checked,
      descConexionEmcali: $('#descConexionEmcali').value.trim(),
      etiquetaRetiq: $('#temaEtiquetaRetiq').checked,
      descEtiquetaRetiq: $('#descEtiquetaRetiq').value.trim(),
      ahorroEnergia: $('#temaAhorroEnergia').checked,
      descAhorroEnergia: $('#descAhorroEnergia').value.trim(),
      consumoEnergia: $('#temaConsumoEnergia').checked,
      descConsumoEnergia: $('#descConsumoEnergia').value.trim(),
    },
    incidencias: {
      variaciones: $('#incVariaciones').value,
      variacionesCant: $('#incVariacionesCant').value.trim(),
      cortes: $('#incCortes').value,
      cortesCant: $('#incCortesCant').value.trim(),
    },
    observaciones: $('#observaciones').value.trim(),
    visita: {
      fecha_local,
      fecha_utc,
      geo: state.cfg.geo ? { lat: state.geo.lat, lng: state.geo.lng } : { lat:null, lng:null }
    },
    consent: $('#consent').checked === true,
    firma: {
      nombre: $('#firmanteNombre').value.trim(),
      pngDataUrl: firmaPng
    },
    sello: {
      userAgent: navigator.userAgent,
      hash_sha256: '',
      qr_payload: ''
    }
  };

  // Hash sobre copia sin imagen de firma para estabilidad
  const hashObj = JSON.parse(JSON.stringify(base));
  if(hashObj.firma) hashObj.firma.pngDataUrl = '[signed]';
  const hash = await sha256Base64(JSON.stringify(hashObj));
  base.sello.hash_sha256 = hash;
  base.sello.qr_payload = JSON.stringify({ id: base.id, hash });
  return base;
}

async function buildPDF(acta){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:'pt', format:'a4' });
  const L = 40, T = 40, W = 515; // m√°rgenes aproximados
  const lineHeight = 12; // Altura de l√≠nea para fuente 9pt
  const sectionSpacing = 25; // Espacio entre secciones

  let y = T; // Posici√≥n Y inicial

  // Funci√≥n helper para agregar texto y actualizar Y
  function addText(text, isTitle = false) {
    if(isTitle) {
      doc.setFont('helvetica','bold');
      doc.setFontSize(10);
    } else {
      doc.setFont('helvetica','normal');
      doc.setFontSize(9);
    }
    const lines = doc.splitTextToSize(text, W);
    doc.text(lines, L, y);
    y += lines.length * lineHeight + (isTitle ? 5 : 0);
  }

  // Encabezado
  doc.setFont('helvetica','bold');
  doc.setFontSize(14);
  doc.text('ACTA DE VISITA ‚Äì FIDELIZACI√ìN EMCALI', L, y);
  y += 25;
  
  doc.setFont('helvetica','normal');
  doc.setFontSize(9);
  doc.text(`ID: ${acta.id}`, L, y);
  y += lineHeight;
  doc.text(`Fecha: ${acta.visita.fecha_local}`, L, y);
  y += lineHeight * 2;

  // Ejecutivo y Ubicaci√≥n
  addText('DATOS DEL EJECUTIVO Y UBICACI√ìN', true);
  addText(`Ejecutivo: ${acta.ejecutivo.nombre}`);
  addText(`Correo: ${acta.ejecutivo.correo}`);
  addText(`Zona: ${acta.ubicacion.zona} | Barrio: ${acta.ubicacion.barrio}`);
  addText(`Direcci√≥n: ${acta.ubicacion.direccion}`);
  y += sectionSpacing;

  // Cliente/Negocio
  addText('DATOS DEL CLIENTE/NEGOCIO', true);
  addText(`N¬∞ Contrato: ${acta.cliente.numeroContrato} | NIT: ${acta.cliente.nit}`);
  addText(`Actividad Econ√≥mica: ${acta.cliente.actividadEconomica}`);
  addText(`Exenci√≥n de Contribuci√≥n: ${acta.cliente.exencionContribucion}`);
  y += sectionSpacing;

  // Persona Encargada
  addText('DATOS DE LA PERSONA ENCARGADA', true);
  addText(`Nombre: ${acta.contacto.nombre} | Cargo: ${acta.contacto.cargo}`);
  addText(`Correo: ${acta.contacto.correo} | Celular: ${acta.contacto.celular}`);
  y += sectionSpacing;

  // Temas Tratados
  addText('TEMAS TRATADOS CON EL CLIENTE', true);
  
  let temasTexto = '';
  if(acta.temasTratados.energiaEficiente) {
    temasTexto += '‚Ä¢ Energ√≠a eficiente:\n  ' + (acta.temasTratados.descEnergiaEficiente || 'Sin descripci√≥n') + '\n\n';
  }
  if(acta.temasTratados.conexionEmcali) {
    temasTexto += '‚Ä¢ Conexi√≥n directa con Emcali:\n  ' + (acta.temasTratados.descConexionEmcali || 'Sin descripci√≥n') + '\n\n';
  }
  if(acta.temasTratados.etiquetaRetiq) {
    temasTexto += '‚Ä¢ Etiqueta RETIQ:\n  ' + (acta.temasTratados.descEtiquetaRetiq || 'Sin descripci√≥n') + '\n\n';
  }
  if(acta.temasTratados.ahorroEnergia) {
    temasTexto += '‚Ä¢ Ahorro de energ√≠a:\n  ' + (acta.temasTratados.descAhorroEnergia || 'Sin descripci√≥n') + '\n\n';
  }
  if(acta.temasTratados.consumoEnergia) {
    temasTexto += '‚Ä¢ Consumo de energ√≠a:\n  ' + (acta.temasTratados.descConsumoEnergia || 'Sin descripci√≥n') + '\n\n';
  }
  
  if(!temasTexto) temasTexto = 'Ning√∫n tema tratado';
  addText(temasTexto);
  y += sectionSpacing;

  // Incidencias
  addText('INCIDENCIAS', true);
  const varText = acta.incidencias.variaciones === 'S√≠' ? 
    `S√≠ (${acta.incidencias.variacionesCant || '0'} veces)` : 
    (acta.incidencias.variaciones || 'No especificado');
  addText(`¬øVariaciones y fluctuaciones?: ${varText}`);
  
  const cortesText = acta.incidencias.cortes === 'S√≠' ? 
    `S√≠ (${acta.incidencias.cortesCant || '0'} veces)` : 
    (acta.incidencias.cortes || 'No especificado');
  addText(`¬øCortes de suministro?: ${cortesText}`);
  y += sectionSpacing;

  // Observaciones
  addText('OBSERVACIONES GENERALES', true);
  addText(acta.observaciones || 'Ninguna');
  y += sectionSpacing;

  // Firma
  addText('FIRMA DEL CLIENTE', true);
  y += 10;
  
  const img = acta.firma.pngDataUrl;
  try{
    doc.addImage(img, 'PNG', L, y, 220, 80);
  }catch{}
  y += 90; // Altura de la imagen + margen
  
  addText(`Nombre: ${acta.firma.nombre}`);
  y += 20;

  // QR + Hash
  try {
    if(typeof QRCode !== 'undefined') {
      const qrCanvas = document.createElement('canvas');
      await QRCode.toCanvas(qrCanvas, acta.sello.qr_payload, { width: 100, margin: 0 });
      const qrData = qrCanvas.toDataURL('image/png');
      doc.addImage(qrData, 'PNG', L+400, y-50, 100, 100);
    }
  } catch(err) {
    console.warn('QRCode no disponible, continuando sin QR');
  }
  
  doc.setFontSize(7);
  const hashLines = doc.splitTextToSize(`Hash SHA-256: ${acta.sello.hash_sha256}`, W-110);
  doc.text(hashLines, L, y);

  // Pie
  doc.setFontSize(8);
  doc.text('Documento generado en sitio y firmado por el cliente. Sistema Acta Express - Emcali.', L, 800);

  const filename = `${acta.id}.pdf`;
  const blob = doc.output('blob');
  return { blob, filename };
}

// ===== Compartir (Outlook / sistema) =====
async function onCompartir(){
  if(!state.ultimoPDFBlob){ toast('Primero genera el PDF'); return; }
  const filename = state.ultimoActa?.archivos?.pdf_filename || 'Acta.pdf';
  
  // SIEMPRE descargar primero el PDF
  const url = URL.createObjectURL(state.ultimoPDFBlob);
  const a = document.createElement('a');
  a.href = url; 
  a.download = filename; 
  a.click();
  URL.revokeObjectURL(url);
  toast('üì• PDF descargado - Adj√∫ntalo a tu correo');
  
  // Intentar Web Share como bonus (no cr√≠tico)
  if(navigator.share && navigator.canShare){
    const file = new File([state.ultimoPDFBlob], filename, { type: 'application/pdf' });
    try{
      if(navigator.canShare({ files:[file] })){
        setTimeout(async ()=>{
          try{
            await navigator.share({
              title: 'Acta de visita',
              text: `Acta de visita ${state.ultimoActa?.id || ''} - ${state.ultimoActa?.cliente?.razon || 'Cliente'}`,
              files: [file]
            });
          }catch(e){ 
            console.log('Web Share fall√≥, pero PDF ya est√° descargado');
          }
        }, 500);
      }
    }catch(e){ 
      console.log('Web Share no disponible');
    }
  }
}

function descargarPDF(){
  if(!state.ultimoPDFBlob){ toast('‚ùå Primero genera el PDF'); return; }
  const filename = state.ultimoActa?.archivos?.pdf_filename || 'Acta.pdf';
  const url = URL.createObjectURL(state.ultimoPDFBlob);
  const a = document.createElement('a');
  a.href = url; 
  a.download = filename; 
  a.click();
  URL.revokeObjectURL(url);
  toast('üì• PDF descargado: ' + filename);
}

function toast(msg){
  $('#estado').textContent = msg;
}

// ===== Historial =====
async function renderHistorial(){
  const cont = $('#historial');
  cont.innerHTML = '';
  const all = (await idbAll()).sort((a,b)=> (a.visita.fecha_utc < b.visita.fecha_utc ? 1 : -1));
  all.forEach(a=>{
    const div = document.createElement('div');
    div.className='flex items-center gap-2 bg-white border rounded p-2';
    const contactoNombre = a.contacto?.nombre || a.cliente?.razon || '-';
    const contrato = a.cliente?.numeroContrato || 'S/N';
    div.innerHTML = `
      <div class="flex-1">
        <div class="font-medium">${a.id} ‚Äì ${contactoNombre}</div>
        <div class="text-xs text-slate-500">${a.visita.fecha_local} | Contrato: ${contrato}</div>
      </div>
      <button class="btn btn-xs" data-id="${a.id}" data-act="share">Compartir</button>
      <button class="btn btn-xs btn-outline" data-id="${a.id}" data-act="excel">A√±adir a Excel</button>
    `;
    div.addEventListener('click', async (ev)=>{
      const btn = ev.target.closest('button'); if(!btn) return;
      const id = btn.dataset.id; const act = btn.dataset.act;
      if(act==='share'){
        // reconstruir PDF desde registro
        state.ultimoActa = a;
        const { blob, filename } = await buildPDF(a);
        state.ultimoPDFBlob = blob;
        await onCompartir();
      }
      if(act==='excel'){
        await appendToExcelMaster([a]);
      }
    });
    cont.appendChild(div);
  });
}

// ====== BLOQUE 2 ‚Äì EXCEL MAESTRO ======
async function onGuardarExcelMaestro(){
  const all = await idbAll();
  await appendToExcelMaster(all, { rebuildIfNoHandle:true });
}

async function appendToExcelMaster(actas, opts={}){
  const name = localStorage.getItem('excelMasterName');
  if(window.showSaveFilePicker && state.excelHandle){
    // Opci√≥n A: abrir/escribir archivo f√≠sico
    try{
      const file = await state.excelHandle.getFile();
      let wb;
      if(file.size > 0){
        const buf = await file.arrayBuffer();
        wb = XLSX.read(buf, { type:'array' });
      } else {
        wb = XLSX.utils.book_new();
      }
      const sheets = ensureSheets(wb);
      mergeRowsIntoSheets(wb, actas);
      const out = XLSX.write(wb, { bookType:'xlsx', type:'array' });
      const writable = await state.excelHandle.createWritable();
      await writable.write(out);
      await writable.close();
      toast(`Excel actualizado${name?' ‚Üí '+name:''}`);
      return;
    }catch(err){ console.warn('Fallo append f√≠sico, usando regenerado', err); }
  }
  // Opci√≥n B: regenerado universal (descarga)
  const wb = XLSX.utils.book_new();
  ensureSheets(wb);
  mergeRowsIntoSheets(wb, actas);
  const out = XLSX.write(wb, { bookType:'xlsx', type:'array' });
  const blob = new Blob([out], { type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
  const a = document.createElement('a');
  const fname = name || 'Actas_Master.xlsx';
  a.href = URL.createObjectURL(blob); a.download = fname; a.click();
  URL.revokeObjectURL(a.href);
  toast('Excel regenerado y descargado');
}

function ensureSheets(wb){
  if(!wb.SheetNames.includes('Actas')){
    const ws = XLSX.utils.aoa_to_sheet([[
      'id_acta','fecha_local','fecha_utc','ejecutivo_nombre','ejecutivo_correo',
      'zona','barrio','direccion',
      'numero_contrato','nit','actividad_economica','exencion_contribucion',
      'contacto_nombre','contacto_cargo','contacto_correo','contacto_celular',
      'tema_energia_eficiente','desc_energia_eficiente',
      'tema_conexion_emcali','desc_conexion_emcali',
      'tema_etiqueta_retiq','desc_etiqueta_retiq',
      'tema_ahorro_energia','desc_ahorro_energia',
      'tema_consumo_energia','desc_consumo_energia',
      'incidencias_variaciones','incidencias_variaciones_cant','incidencias_cortes','incidencias_cortes_cant',
      'observaciones','firmante_nombre',
      'geo_lat','geo_lng','hash_sha256','pdf_filename'
    ]]);
    XLSX.utils.book_append_sheet(wb, ws, 'Actas');
  }
  return wb.Sheets;
}

function mergeRowsIntoSheets(wb, actas){
  const wsA = wb.Sheets['Actas'];
  const rangeA = XLSX.utils.decode_range(wsA['!ref'] || 'A1:A1');

  // Build existing IDs set para anti-duplicados
  const existingIds = new Set();
  for(let R=1; R<=rangeA.e.r; R++){
    const cell = wsA[XLSX.utils.encode_cell({c:0,r:R})];
    if(cell && cell.v) existingIds.add(String(cell.v));
  }

  let rowsA = [];

  for(const a of actas){
    if(existingIds.has(a.id)) continue;
    rowsA.push([
      a.id,
      a.visita?.fecha_local||'',
      a.visita?.fecha_utc||'',
      a.ejecutivo?.nombre||'',
      a.ejecutivo?.correo||'',
      a.ubicacion?.zona||'',
      a.ubicacion?.barrio||'',
      a.ubicacion?.direccion||'',
      a.cliente?.numeroContrato||'',
      a.cliente?.nit||'',
      a.cliente?.actividadEconomica||'',
      a.cliente?.exencionContribucion||'',
      a.contacto?.nombre||'',
      a.contacto?.cargo||'',
      a.contacto?.correo||'',
      a.contacto?.celular||'',
      a.temasTratados?.energiaEficiente ? 'S√≠' : 'No',
      a.temasTratados?.descEnergiaEficiente||'',
      a.temasTratados?.conexionEmcali ? 'S√≠' : 'No',
      a.temasTratados?.descConexionEmcali||'',
      a.temasTratados?.etiquetaRetiq ? 'S√≠' : 'No',
      a.temasTratados?.descEtiquetaRetiq||'',
      a.temasTratados?.ahorroEnergia ? 'S√≠' : 'No',
      a.temasTratados?.descAhorroEnergia||'',
      a.temasTratados?.consumoEnergia ? 'S√≠' : 'No',
      a.temasTratados?.descConsumoEnergia||'',
      a.incidencias?.variaciones||'',
      a.incidencias?.variacionesCant||'',
      a.incidencias?.cortes||'',
      a.incidencias?.cortesCant||'',
      a.observaciones||'',
      a.firma?.nombre||'',
      a.visita?.geo?.lat||'',
      a.visita?.geo?.lng||'',
      a.sello?.hash_sha256||'',
      a.archivos?.pdf_filename||''
    ]);
  }

  if(rowsA.length){
    XLSX.utils.sheet_add_aoa(wsA, rowsA, { origin: -1 });
  }

  // Ajuste de rango
  const totalCols = 37; // N√∫mero de columnas (32 + 5 descripciones de temas)
  wsA['!ref'] = wsA['!ref'] || `A1:${XLSX.utils.encode_col(totalCols-1)}${1+rowsA.length}`;
}


<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Acta Express</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="./styles.css">
</head>
<body class="bg-slate-50 text-slate-800">
    <header class="p-4 bg-sky-600 text-white shadow">
        <h1 class="text-xl font-semibold">üìä Dashboard Acta Express</h1>
        <p class="text-sm opacity-90">An√°lisis y reportes de actas de visita</p>
    </header>

    <main class="p-4 space-y-6 max-w-7xl mx-auto">
        <!-- Cargar Datos -->
        <section class="card">
            <h2 class="card-title">üìä An√°lisis de Actas</h2>
            <div class="flex flex-wrap gap-3">
                <button id="btnCargarDatos" class="btn">üîÑ Cargar Datos del Historial</button>
                <button id="btnGenerarReporte" class="btn btn-outline" disabled>üìÑ Generar Reporte Excel</button>
                <button id="btnExportarExcelMaestro" class="btn btn-ghost">üì• Exportar Excel Maestro</button>
                <button id="btnBorrarTodas" class="btn btn-ghost text-red-600 hover:bg-red-50">üóëÔ∏è Borrar Todas las Actas</button>
                <button id="btnDebug" class="btn btn-ghost">üêõ Debug</button>
            </div>
            <p id="estadoDatos" class="text-xs text-slate-500 mt-2"></p>
        </section>

        <!-- Resumen General -->
        <div id="resumenGeneral" class="hidden grid gap-4 md:grid-cols-4">
            <div class="card bg-blue-50 border-blue-200">
                <div class="text-2xl font-bold text-blue-600" id="totalActas">0</div>
                <div class="text-sm text-blue-800">Total Actas</div>
            </div>
            <div class="card bg-green-50 border-green-200">
                <div class="text-2xl font-bold text-green-600" id="totalCompromisos">0</div>
                <div class="text-sm text-green-800">Zonas √önicas</div>
            </div>
            <div class="card bg-purple-50 border-purple-200">
                <div class="text-2xl font-bold text-purple-600" id="clientesUnicos">0</div>
                <div class="text-sm text-purple-800">Contactos √önicos</div>
            </div>
            <div class="card bg-orange-50 border-orange-200">
                <div class="text-2xl font-bold text-orange-600" id="promedioCompromisos">0</div>
                <div class="text-sm text-orange-800">Promedio Temas/Acta</div>
            </div>
        </div>

        <!-- Gr√°ficos -->
        <div id="graficos" class="hidden grid gap-6 md:grid-cols-2">
            <!-- Actas por Mes -->
            <div class="card">
                <h3 class="card-title">üìÖ Actas por Mes</h3>
                <canvas id="chartActasMes" width="400" height="200"></canvas>
            </div>

            <!-- Zonas de Visita -->
            <div class="card">
                <h3 class="card-title">üéØ Zonas de Visita</h3>
                <canvas id="chartMotivos" width="400" height="200"></canvas>
            </div>

            <!-- Top Contactos -->
            <div class="card">
                <h3 class="card-title">üèÜ Top 10 Contactos</h3>
                <canvas id="chartTopClientes" width="400" height="200"></canvas>
            </div>

            <!-- Temas Tratados -->
            <div class="card">
                <h3 class="card-title">‚úÖ Temas Tratados</h3>
                <canvas id="chartCompromisosEstado" width="400" height="200"></canvas>
            </div>
        </div>

        <!-- Tablas de Datos -->
        <div id="tablas" class="hidden space-y-6">
            <!-- Tabla de Actas Recientes -->
            <section class="card">
                <h3 class="card-title">üìã Actas Recientes</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-slate-100">
                            <tr>
                                <th class="p-2 text-left">ID</th>
                                <th class="p-2 text-left">Contacto</th>
                                <th class="p-2 text-left">Fecha</th>
                                <th class="p-2 text-left">Contrato</th>
                                <th class="p-2 text-left">Zona</th>
                                <th class="p-2 text-left">Ejecutivo</th>
                            </tr>
                        </thead>
                        <tbody id="tablaActasRecientes">
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Tabla de Compromisos Pendientes -->
            <section class="card">
                <h3 class="card-title">‚è∞ Compromisos Pendientes</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-slate-100">
                            <tr>
                                <th class="p-2 text-left">ID Acta</th>
                                <th class="p-2 text-left">Cliente</th>
                                <th class="p-2 text-left">Compromiso</th>
                                <th class="p-2 text-left">Fecha L√≠mite</th>
                                <th class="p-2 text-left">Estado</th>
                                <th class="p-2 text-left">D√≠as Vencido</th>
                            </tr>
                        </thead>
                        <tbody id="tablaCompromisosPendientes">
                        </tbody>
                    </table>
                </div>
            </section>
        </div>

        <!-- Filtros -->
        <div id="filtros" class="hidden card">
            <h3 class="card-title">üîç Filtros</h3>
            <div class="grid gap-4 md:grid-cols-4">
                <div>
                    <label class="lbl">Fecha Desde</label>
                    <input type="date" id="filtroFechaDesde" class="inp">
                </div>
                <div>
                    <label class="lbl">Fecha Hasta</label>
                    <input type="date" id="filtroFechaHasta" class="inp">
                </div>
                <div>
                    <label class="lbl">Zona</label>
                    <select id="filtroMotivo" class="inp">
                        <option value="">Todas</option>
                    </select>
                </div>
                <div>
                    <label class="lbl">Ejecutivo</label>
                    <select id="filtroEjecutivo" class="inp">
                        <option value="">Todos</option>
                    </select>
                </div>
            </div>
            <div class="mt-3 flex gap-2">
                <button id="btnAplicarFiltros" class="btn">Aplicar Filtros</button>
                <button id="btnLimpiarFiltros" class="btn btn-outline">Limpiar</button>
            </div>
        </div>
    </main>

    <script src="./dashboard.js"></script>
</body>
</html>

// dashboard.js - An√°lisis y reportes del Excel maestro
imported();
async function imported(){ /* noop to hint module */ }

// ===== UTILIDADES =====
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => [...document.querySelectorAll(sel)];
const sleep = (ms) => new Promise(r => setTimeout(r, ms));

// Estado global
const state = {
  data: {
    actas: [],
    compromisos: [],
    filtrada: {
      actas: [],
      compromisos: []
    }
  },
  charts: {},
  filtros: {
    fechaDesde: null,
    fechaHasta: null,
    motivo: '',
    ejecutivo: ''
  }
};

// IndexedDB
let db;
const DB_NAME = 'acta_express_db';
const DB_STORE = 'actas';

// ===== INICIALIZACI√ìN =====
init();

async function init(){
  try{
    await idbOpen();
    bindUI();
    setupDateFilters();
    // Cargar datos autom√°ticamente
    await loadDataFromIndexedDB();
  }catch(err){
    console.error('Error en init:', err);
    $('#estadoDatos').textContent = '‚ùå Error inicializando dashboard: ' + err.message;
  }
}

function bindUI(){
  $('#btnCargarDatos').addEventListener('click', loadDataFromIndexedDB);
  $('#btnGenerarReporte').addEventListener('click', generarReportePDF);
  $('#btnExportarExcelMaestro').addEventListener('click', exportarExcelMaestro);
  $('#btnDebug').addEventListener('click', debugInfo);
  $('#btnAplicarFiltros').addEventListener('click', aplicarFiltros);
  $('#btnLimpiarFiltros').addEventListener('click', limpiarFiltros);
  $('#btnBorrarTodas').addEventListener('click', borrarTodasActas);
}

// ===== IndexedDB =====
function idbOpen(){
  return new Promise((resolve, reject)=>{
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = (e)=>{
      const db = req.result;
      if(!db.objectStoreNames.contains(DB_STORE)){
        db.createObjectStore(DB_STORE, { keyPath: 'id' });
      }
    };
    req.onsuccess = ()=>{ db = req.result; resolve(); };
    req.onerror = ()=> reject(req.error);
  });
}

function idbAll(){
  return new Promise((resolve,reject)=>{
    const tx = db.transaction(DB_STORE,'readonly');
    const req = tx.objectStore(DB_STORE).getAll();
    req.onsuccess=()=>resolve(req.result||[]);
    req.onerror=()=>reject(req.error);
  });
}

function idbClear(){
  return new Promise((resolve,reject)=>{
    const tx = db.transaction(DB_STORE,'readwrite');
    const req = tx.objectStore(DB_STORE).clear();
    req.onsuccess=()=>resolve();
    req.onerror=()=>reject(req.error);
  });
}

function setupDateFilters(){
  // Fecha desde: hace 3 meses
  const hace3Meses = new Date();
  hace3Meses.setMonth(hace3Meses.getMonth() - 3);
  $('#filtroFechaDesde').value = hace3Meses.toISOString().split('T')[0];
  
  // Fecha hasta: hoy
  $('#filtroFechaHasta').value = new Date().toISOString().split('T')[0];
}

// ===== CARGA DESDE INDEXEDDB =====
async function loadDataFromIndexedDB(){
  try{
    $('#estadoDatos').textContent = 'üìñ Cargando datos del historial...';
    
    console.log('Intentando cargar datos de IndexedDB...');
    const actasRaw = await idbAll();
    console.log('Datos cargados:', actasRaw);
    
    if(actasRaw.length === 0){
      $('#estadoDatos').textContent = '‚ö†Ô∏è No hay actas en el historial. Ve a la p√°gina principal, genera algunas actas y vuelve aqu√≠.';
      return;
    }
    
    // Convertir formato de IndexedDB al formato esperado por el dashboard
    // Compatible con formato nuevo y formato antiguo
    state.data.actas = actasRaw.map(acta => {
      // Detectar si es formato nuevo o antiguo
      const isNewFormat = acta.contacto && acta.temasTratados;
      
      if(isNewFormat) {
        // Formato nuevo - fidelizaci√≥n Emcali
        return {
          id_acta: acta.id,
          fecha_local: acta.visita?.fecha_local || '',
          fecha_utc: acta.visita?.fecha_utc || '',
          ejecutivo_nombre: acta.ejecutivo?.nombre || '',
          ejecutivo_correo: acta.ejecutivo?.correo || '',
          zona: acta.ubicacion?.zona || '',
          barrio: acta.ubicacion?.barrio || '',
          direccion: acta.ubicacion?.direccion || '',
          numero_contrato: acta.cliente?.numeroContrato || '',
          cliente_nit: acta.cliente?.nit || '',
          actividad_economica: acta.cliente?.actividadEconomica || '',
          exencion_contribucion: acta.cliente?.exencionContribucion || '',
          contacto_nombre: acta.contacto?.nombre || '',
          contacto_cargo: acta.contacto?.cargo || '',
          contacto_correo: acta.contacto?.correo || '',
          contacto_celular: acta.contacto?.celular || '',
          tema_energia_eficiente: acta.temasTratados?.energiaEficiente ? 'S√≠' : 'No',
          desc_energia_eficiente: acta.temasTratados?.descEnergiaEficiente || '',
          tema_conexion_emcali: acta.temasTratados?.conexionEmcali ? 'S√≠' : 'No',
          desc_conexion_emcali: acta.temasTratados?.descConexionEmcali || '',
          tema_etiqueta_retiq: acta.temasTratados?.etiquetaRetiq ? 'S√≠' : 'No',
          desc_etiqueta_retiq: acta.temasTratados?.descEtiquetaRetiq || '',
          tema_ahorro_energia: acta.temasTratados?.ahorroEnergia ? 'S√≠' : 'No',
          desc_ahorro_energia: acta.temasTratados?.descAhorroEnergia || '',
          tema_consumo_energia: acta.temasTratados?.consumoEnergia ? 'S√≠' : 'No',
          desc_consumo_energia: acta.temasTratados?.descConsumoEnergia || '',
          incidencias_variaciones: acta.incidencias?.variaciones || '',
          incidencias_variaciones_cant: acta.incidencias?.variacionesCant || '',
          incidencias_cortes: acta.incidencias?.cortes || '',
          incidencias_cortes_cant: acta.incidencias?.cortesCant || '',
          observaciones: acta.observaciones || '',
          firmante_nombre: acta.firma?.nombre || '',
          geo_lat: acta.visita?.geo?.lat || '',
          geo_lng: acta.visita?.geo?.lng || '',
          hash_sha256: acta.sello?.hash_sha256 || '',
          pdf_filename: acta.archivos?.pdf_filename || '',
          formato: 'nuevo'
        };
      } else {
        // Formato antiguo - compatibilidad
        return {
          id_acta: acta.id,
          fecha_local: acta.visita?.fecha_local || '',
          fecha_utc: acta.visita?.fecha_utc || '',
          ejecutivo_nombre: acta.ejecutivo?.nombre || '',
          ejecutivo_correo: acta.ejecutivo?.correo || '',
          zona: '',
          barrio: '',
          direccion: '',
          numero_contrato: '',
          cliente_nit: acta.cliente?.nit || '',
          actividad_economica: '',
          exencion_contribucion: '',
          contacto_nombre: acta.cliente?.contacto || 'Sin contacto',
          contacto_cargo: '',
          contacto_correo: acta.cliente?.email || '',
          contacto_celular: '',
          tema_energia_eficiente: 'No',
          desc_energia_eficiente: '',
          tema_conexion_emcali: 'No',
          desc_conexion_emcali: '',
          tema_etiqueta_retiq: 'No',
          desc_etiqueta_retiq: '',
          tema_ahorro_energia: 'No',
          desc_ahorro_energia: '',
          tema_consumo_energia: 'No',
          desc_consumo_energia: '',
          incidencias_variaciones: '',
          incidencias_variaciones_cant: '',
          incidencias_cortes: '',
          incidencias_cortes_cant: '',
          observaciones: '',
          firmante_nombre: acta.firma?.nombre || '',
          geo_lat: acta.visita?.geo?.lat || '',
          geo_lng: acta.visita?.geo?.lng || '',
          hash_sha256: acta.sello?.hash_sha256 || '',
          pdf_filename: acta.archivos?.pdf_filename || '',
          formato: 'antiguo'
        };
      }
    });
    
    // Crear compromisos expandidos
    state.data.compromisos = [];
    actasRaw.forEach(acta => {
      (acta.contenido?.compromisos || []).forEach(comp => {
        state.data.compromisos.push({
          id_acta: acta.id,
          compromiso: comp.texto || '',
          fecha_compromiso: comp.fecha || '',
          estado: 'pendiente' // Por defecto
        });
      });
    });

    // Contar formatos
    const nuevas = state.data.actas.filter(a => a.formato === 'nuevo').length;
    const antiguas = state.data.actas.filter(a => a.formato === 'antiguo').length;
    
    $('#estadoDatos').textContent = `‚úÖ Cargadas ${state.data.actas.length} actas (${nuevas} nuevas, ${antiguas} antiguas) y ${state.data.compromisos.length} compromisos`;
    
    // Aplicar filtros iniciales
    aplicarFiltros();
    
    console.log('Datos procesados:', state.data.actas.length, 'actas,', state.data.compromisos.length, 'compromisos');
    
    // Mostrar interfaz
    mostrarDashboard();
    
    // Generar gr√°ficos
    generarGraficos();
    
    // Llenar filtros
    llenarFiltros();
    
    // Llenar tablas
    llenarTablas();
    
    $('#btnGenerarReporte').disabled = false;
    
  }catch(err){
    console.error(err);
    $('#estadoDatos').textContent = `‚ùå Error: ${err.message}`;
    toast('Error cargando datos');
  }
}

function mostrarDashboard(){
  console.log('Mostrando dashboard...');
  
  const elementos = ['#resumenGeneral', '#graficos', '#tablas', '#filtros'];
  elementos.forEach(selector => {
    const el = $(selector);
    if(el) {
      el.classList.remove('hidden');
      console.log('Mostrado:', selector);
    } else {
      console.error('Elemento no encontrado:', selector);
    }
  });
}

// ===== AN√ÅLISIS Y ESTAD√çSTICAS =====
function calcularResumen(){
  const actas = state.data.filtrada.actas;
  
  // Total actas
  $('#totalActas').textContent = actas.length;
  
  // Zonas √∫nicas
  const zonasUnicas = new Set(actas.map(a => a.zona).filter(Boolean));
  $('#totalCompromisos').textContent = zonasUnicas.size;
  
  // Contactos √∫nicos
  const contactosUnicos = new Set(actas.map(a => a.contacto_nombre).filter(Boolean));
  $('#clientesUnicos').textContent = contactosUnicos.size;
  
  // Promedio de temas tratados por acta
  let totalTemas = 0;
  actas.forEach(acta => {
    if(acta.tema_energia_eficiente === 'S√≠') totalTemas++;
    if(acta.tema_conexion_emcali === 'S√≠') totalTemas++;
    if(acta.tema_etiqueta_retiq === 'S√≠') totalTemas++;
    if(acta.tema_ahorro_energia === 'S√≠') totalTemas++;
    if(acta.tema_consumo_energia === 'S√≠') totalTemas++;
  });
  const promedio = actas.length > 0 ? (totalTemas / actas.length).toFixed(1) : '0';
  $('#promedioCompromisos').textContent = promedio;
}

function llenarFiltros(){
  const actas = state.data.actas;
  
  // Zonas √∫nicas
  const zonas = [...new Set(actas.map(a => a.zona).filter(Boolean))];
  const selectMotivo = $('#filtroMotivo');
  selectMotivo.innerHTML = '<option value="">Todas las zonas</option>';
  zonas.forEach(zona => {
    const option = document.createElement('option');
    option.value = zona;
    option.textContent = zona;
    selectMotivo.appendChild(option);
  });
  
  // Ejecutivos √∫nicos
  const ejecutivos = [...new Set(actas.map(a => a.ejecutivo_nombre || 'Sin asignar').filter(Boolean))];
  const selectEjecutivo = $('#filtroEjecutivo');
  selectEjecutivo.innerHTML = '<option value="">Todos</option>';
  ejecutivos.forEach(ejecutivo => {
    const option = document.createElement('option');
    option.value = ejecutivo;
    option.textContent = ejecutivo;
    selectEjecutivo.appendChild(option);
  });
}

// ===== FILTROS =====
function aplicarFiltros(){
  const actas = state.data.actas;
  const compromisos = state.data.compromisos;
  
  // Obtener filtros
  state.filtros.fechaDesde = $('#filtroFechaDesde').value;
  state.filtros.fechaHasta = $('#filtroFechaHasta').value;
  state.filtros.zona = $('#filtroMotivo').value; // Usamos el select de motivo para zonas
  state.filtros.ejecutivo = $('#filtroEjecutivo').value;
  
  // Aplicar filtros a actas
  let actasFiltradas = actas.filter(acta => {
    // Filtro por fecha
    if(state.filtros.fechaDesde && acta.fecha_local){
      const fechaActa = new Date(acta.fecha_local);
      const fechaDesde = new Date(state.filtros.fechaDesde);
      if(fechaActa < fechaDesde) return false;
    }
    
    if(state.filtros.fechaHasta && acta.fecha_local){
      const fechaActa = new Date(acta.fecha_local);
      const fechaHasta = new Date(state.filtros.fechaHasta);
      if(fechaActa > fechaHasta) return false;
    }
    
    // Filtro por zona
    if(state.filtros.zona && acta.zona !== state.filtros.zona){
      return false;
    }
    
    // Filtro por ejecutivo
    if(state.filtros.ejecutivo && acta.ejecutivo_nombre !== state.filtros.ejecutivo){
      return false;
    }
    
    return true;
  });
  
  // Filtrar compromisos basado en actas filtradas
  const idsActasFiltradas = new Set(actasFiltradas.map(a => a.id_acta));
  const compromisosFiltrados = compromisos.filter(c => idsActasFiltradas.has(c.id_acta));
  
  state.data.filtrada.actas = actasFiltradas;
  state.data.filtrada.compromisos = compromisosFiltrados;
  
  // Actualizar resumen y gr√°ficos
  calcularResumen();
  generarGraficos();
  llenarTablas();
  
  toast(`Filtros aplicados: ${actasFiltradas.length} actas, ${compromisosFiltrados.length} compromisos`);
}

function limpiarFiltros(){
  $('#filtroFechaDesde').value = '';
  $('#filtroFechaHasta').value = '';
  $('#filtroMotivo').value = ''; // Zonas
  $('#filtroEjecutivo').value = '';
  
  state.data.filtrada.actas = state.data.actas;
  state.data.filtrada.compromisos = state.data.compromisos;
  
  calcularResumen();
  generarGraficos();
  llenarTablas();
  
  toast('Filtros limpiados');
}

// ===== GR√ÅFICOS =====
function generarGraficos(){
  const actas = state.data.filtrada.actas;
  const compromisos = state.data.filtrada.compromisos;
  
  generarGraficoActasMes(actas);
  generarGraficoZonas(actas);
  generarGraficoTopContactos(actas);
  generarGraficoTemasTratados(actas);
}

function generarGraficoActasMes(actas){
  const ctx = $('#chartActasMes').getContext('2d');
  
  // Agrupar por mes
  const porMes = {};
  actas.forEach(acta => {
    if(acta.fecha_local){
      const fecha = new Date(acta.fecha_local);
      const mes = `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}`;
      porMes[mes] = (porMes[mes] || 0) + 1;
    }
  });
  
  const labels = Object.keys(porMes).sort();
  const data = labels.map(mes => porMes[mes]);
  
  if(state.charts.actasMes){
    state.charts.actasMes.destroy();
  }
  
  state.charts.actasMes = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Actas',
        data: data,
        backgroundColor: 'rgba(14, 165, 233, 0.8)',
        borderColor: 'rgba(14, 165, 233, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });
}

function generarGraficoZonas(actas){
  const ctx = $('#chartMotivos').getContext('2d');
  
  // Contar zonas
  const zonas = {};
  actas.forEach(acta => {
    const zona = acta.zona || 'Sin zona';
    zonas[zona] = (zonas[zona] || 0) + 1;
  });
  
  const labels = Object.keys(zonas);
  const data = Object.values(zonas);
  
  if(state.charts.zonas){
    state.charts.zonas.destroy();
  }
  
  state.charts.zonas = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: labels,
      datasets: [{
        data: data,
        backgroundColor: [
          'rgba(14, 165, 233, 0.8)',
          'rgba(34, 197, 94, 0.8)',
          'rgba(251, 191, 36, 0.8)',
          'rgba(239, 68, 68, 0.8)',
          'rgba(168, 85, 247, 0.8)'
        ]
      }]
    },
    options: {
      responsive: true
    }
  });
}

function generarGraficoTopContactos(actas){
  const ctx = $('#chartTopClientes').getContext('2d');
  
  // Contar por contacto
  const porContacto = {};
  actas.forEach(acta => {
    const contacto = acta.contacto_nombre || 'Sin contacto';
    porContacto[contacto] = (porContacto[contacto] || 0) + 1;
  });
  
  // Top 10
  const sorted = Object.entries(porContacto)
    .sort(([,a], [,b]) => b - a)
    .slice(0, 10);
  
  const labels = sorted.map(([contacto]) => contacto);
  const data = sorted.map(([,count]) => count);
  
  if(state.charts.topContactos){
    state.charts.topContactos.destroy();
  }
  
  state.charts.topContactos = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Visitas',
        data: data,
        backgroundColor: 'rgba(14, 165, 233, 0.8)'
      }]
    },
    options: {
      responsive: true,
      indexAxis: 'y'
    }
  });
}

function generarGraficoTemasTratados(actas){
  const ctx = $('#chartCompromisosEstado').getContext('2d');
  
  // Contar temas tratados
  const temas = {
    'Energ√≠a Eficiente': 0,
    'Conexi√≥n Emcali': 0,
    'Etiqueta RETIQ': 0,
    'Ahorro Energ√≠a': 0,
    'Consumo Energ√≠a': 0
  };
  
  actas.forEach(acta => {
    if(acta.tema_energia_eficiente === 'S√≠') temas['Energ√≠a Eficiente']++;
    if(acta.tema_conexion_emcali === 'S√≠') temas['Conexi√≥n Emcali']++;
    if(acta.tema_etiqueta_retiq === 'S√≠') temas['Etiqueta RETIQ']++;
    if(acta.tema_ahorro_energia === 'S√≠') temas['Ahorro Energ√≠a']++;
    if(acta.tema_consumo_energia === 'S√≠') temas['Consumo Energ√≠a']++;
  });
  
  const labels = Object.keys(temas);
  const data = Object.values(temas);
  
  if(state.charts.temasTratados){
    state.charts.temasTratados.destroy();
  }
  
  state.charts.temasTratados = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: labels,
      datasets: [{
        data: data,
        backgroundColor: [
          'rgba(14, 165, 233, 0.8)',   // azul
          'rgba(34, 197, 94, 0.8)',    // verde
          'rgba(251, 191, 36, 0.8)',   // amarillo
          'rgba(239, 68, 68, 0.8)',    // rojo
          'rgba(168, 85, 247, 0.8)'    // morado
        ]
      }]
    },
    options: {
      responsive: true
    }
  });
}

// ===== TABLAS =====
function llenarTablas(){
  llenarTablaActasRecientes();
}

function llenarTablaActasRecientes(){
  const tbody = $('#tablaActasRecientes');
  tbody.innerHTML = '';
  
  const actas = state.data.filtrada.actas
    .sort((a, b) => {
      // Ordenar por fecha UTC si est√° disponible, sino por fecha local
      const fechaA = new Date(a.fecha_utc || a.fecha_local);
      const fechaB = new Date(b.fecha_utc || b.fecha_local);
      return fechaB - fechaA;
    })
    .slice(0, 10);
  
  actas.forEach(acta => {
    const row = document.createElement('tr');
    row.className = 'border-b hover:bg-slate-50';
    row.innerHTML = `
      <td class="p-2 font-mono text-xs">${acta.id_acta || '-'}</td>
      <td class="p-2">${acta.contacto_nombre || '-'}</td>
      <td class="p-2 text-sm">${formatearFecha(acta.fecha_local)}</td>
      <td class="p-2">${acta.numero_contrato || '-'}</td>
      <td class="p-2">${acta.zona || '-'}</td>
      <td class="p-2">${acta.ejecutivo_nombre || '-'}</td>
    `;
    tbody.appendChild(row);
  });
}


// ===== UTILIDADES =====
function formatearFecha(fecha){
  if(!fecha) return '-';
  try{
    // Si la fecha viene como string "Invalid Date", intentar parsearla
    const fechaObj = new Date(fecha);
    if(isNaN(fechaObj.getTime())) {
      return fecha; // Retornar el string original si no se puede parsear
    }
    return fechaObj.toLocaleDateString('es-ES');
  }catch{
    return fecha;
  }
}

function calcularDiasVencido(fechaLimite){
  if(!fechaLimite) return 0;
  try{
    const fecha = new Date(fechaLimite);
    const hoy = new Date();
    const diffTime = hoy - fecha;
    return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  }catch{
    return 0;
  }
}

async function exportarExcelMaestro(){
  try{
    toast('üì• Generando Excel maestro...');
    
    // Usar la misma funci√≥n que en app.js
    const all = await idbAll();
    await appendToExcelMaster(all, { rebuildIfNoHandle: true });
    
  }catch(err){
    console.error(err);
    toast('‚ùå Error generando Excel maestro');
  }
}

// Funci√≥n copiada de app.js para generar Excel maestro
async function appendToExcelMaster(actas, opts={}){
  const name = localStorage.getItem('excelMasterName') || 'Actas_Master.xlsx';
  
  // Opci√≥n B: regenerado universal (descarga)
  const wb = XLSX.utils.book_new();
  ensureSheets(wb);
  mergeRowsIntoSheets(wb, actas);
  const out = XLSX.write(wb, { bookType:'xlsx', type:'array' });
  const blob = new Blob([out], { type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
  const a = document.createElement('a');
  const fname = name;
  a.href = URL.createObjectURL(blob); a.download = fname; a.click();
  URL.revokeObjectURL(a.href);
  toast('üì• Excel maestro descargado: ' + fname);
}

function ensureSheets(wb){
  if(!wb.SheetNames.includes('Actas')){
    const ws = XLSX.utils.aoa_to_sheet([[
      'id_acta','fecha_local','fecha_utc','ejecutivo_nombre','ejecutivo_correo',
      'zona','barrio','direccion',
      'numero_contrato','nit','actividad_economica','exencion_contribucion',
      'contacto_nombre','contacto_cargo','contacto_correo','contacto_celular',
      'tema_energia_eficiente','desc_energia_eficiente',
      'tema_conexion_emcali','desc_conexion_emcali',
      'tema_etiqueta_retiq','desc_etiqueta_retiq',
      'tema_ahorro_energia','desc_ahorro_energia',
      'tema_consumo_energia','desc_consumo_energia',
      'incidencias_variaciones','incidencias_variaciones_cant','incidencias_cortes','incidencias_cortes_cant',
      'observaciones','firmante_nombre',
      'geo_lat','geo_lng','hash_sha256','pdf_filename'
    ]]);
    XLSX.utils.book_append_sheet(wb, ws, 'Actas');
  }
  return wb.Sheets;
}

function mergeRowsIntoSheets(wb, actas){
  const wsA = wb.Sheets['Actas'];
  
  let rowsA = [];

  for(const a of actas){
    rowsA.push([
      a.id,
      a.visita?.fecha_local||'',
      a.visita?.fecha_utc||'',
      a.ejecutivo?.nombre||'',
      a.ejecutivo?.correo||'',
      a.ubicacion?.zona||'',
      a.ubicacion?.barrio||'',
      a.ubicacion?.direccion||'',
      a.cliente?.numeroContrato||'',
      a.cliente?.nit||'',
      a.cliente?.actividadEconomica||'',
      a.cliente?.exencionContribucion||'',
      a.contacto?.nombre||'',
      a.contacto?.cargo||'',
      a.contacto?.correo||'',
      a.contacto?.celular||'',
      a.temasTratados?.energiaEficiente ? 'S√≠' : 'No',
      a.temasTratados?.descEnergiaEficiente||'',
      a.temasTratados?.conexionEmcali ? 'S√≠' : 'No',
      a.temasTratados?.descConexionEmcali||'',
      a.temasTratados?.etiquetaRetiq ? 'S√≠' : 'No',
      a.temasTratados?.descEtiquetaRetiq||'',
      a.temasTratados?.ahorroEnergia ? 'S√≠' : 'No',
      a.temasTratados?.descAhorroEnergia||'',
      a.temasTratados?.consumoEnergia ? 'S√≠' : 'No',
      a.temasTratados?.descConsumoEnergia||'',
      a.incidencias?.variaciones||'',
      a.incidencias?.variacionesCant||'',
      a.incidencias?.cortes||'',
      a.incidencias?.cortesCant||'',
      a.observaciones||'',
      a.firma?.nombre||'',
      a.visita?.geo?.lat||'',
      a.visita?.geo?.lng||'',
      a.sello?.hash_sha256||'',
      a.archivos?.pdf_filename||''
    ]);
  }

  if(rowsA.length){
    XLSX.utils.sheet_add_aoa(wsA, rowsA, { origin: -1 });
  }

  // Ajuste de rango - 37 columnas
  const totalCols = 37;
  wsA['!ref'] = wsA['!ref'] || `A1:${XLSX.utils.encode_col(totalCols-1)}${1+rowsA.length}`;
}

function debugInfo(){
  console.log('=== DEBUG INFO ===');
  console.log('DB:', db);
  console.log('State:', state);
  console.log('Actas cargadas:', state.data.actas.length);
  console.log('Compromisos cargados:', state.data.compromisos.length);
  
  // Mostrar informaci√≥n de formatos
  const nuevas = state.data.actas.filter(a => a.formato === 'nuevo').length;
  const antiguas = state.data.actas.filter(a => a.formato === 'antiguo').length;
  console.log(`=== FORMATOS DETECTADOS ===`);
  console.log(`Formato nuevo: ${nuevas} actas`);
  console.log(`Formato antiguo: ${antiguas} actas`);
  
  // Mostrar las primeras 3 actas para debug
  if(state.data.actas.length > 0) {
    console.log('=== PRIMERA ACTA (formato dashboard) ===');
    console.log(state.data.actas[0]);
    
    console.log('=== CAMPOS CLAVE ===');
    console.log('formato:', state.data.actas[0].formato);
    console.log('contacto_nombre:', state.data.actas[0].contacto_nombre);
    console.log('numero_contrato:', state.data.actas[0].numero_contrato);
    console.log('zona:', state.data.actas[0].zona);
    console.log('tema_energia_eficiente:', state.data.actas[0].tema_energia_eficiente);
    console.log('tema_conexion_emcali:', state.data.actas[0].tema_conexion_emcali);
  }
  
  // Mostrar datos raw de IndexedDB
  idbAll().then(rawData => {
    console.log('=== DATOS RAW DE INDEXEDDB ===');
    if(rawData.length > 0) {
      console.log('Primera acta raw:', rawData[0]);
      console.log('Estructura de la primera acta:');
      console.log('- ejecutivo:', rawData[0].ejecutivo);
      console.log('- ubicacion:', rawData[0].ubicacion);
      console.log('- cliente:', rawData[0].cliente);
      console.log('- contacto:', rawData[0].contacto);
      console.log('- temasTratados:', rawData[0].temasTratados);
      console.log('- incidencias:', rawData[0].incidencias);
    }
  });
  
  console.log('Elementos del DOM:');
  console.log('- #resumenGeneral:', $('#resumenGeneral'));
  console.log('- #graficos:', $('#graficos'));
  console.log('- #tablas:', $('#tablas'));
  console.log('- #filtros:', $('#filtros'));
  
  $('#estadoDatos').textContent = `Debug: ${state.data.actas.length} actas. Ver consola para m√°s detalles.`;
}

async function borrarTodasActas(){
  try{
    // Confirmar antes de borrar
    const confirmar = confirm('‚ö†Ô∏è ¬øEst√°s seguro de que quieres borrar TODAS las actas?\n\nEsta acci√≥n NO se puede deshacer.');
    if(!confirmar) return;
    
    $('#estadoDatos').textContent = 'üóëÔ∏è Borrando todas las actas...';
    
    // Contar actas antes de borrar
    const totalActas = await idbAll();
    const cantidad = totalActas.length;
    
    // Borrar todas las actas
    await idbClear();
    
    // Limpiar estado
    state.data.actas = [];
    state.data.compromisos = [];
    state.data.filtrada.actas = [];
    state.data.filtrada.compromisos = [];
    
    // Ocultar dashboard
    const elementos = ['#resumenGeneral', '#graficos', '#tablas', '#filtros'];
    elementos.forEach(selector => {
      const el = $(selector);
      if(el) el.classList.add('hidden');
    });
    
    $('#estadoDatos').textContent = `‚úÖ Se borraron ${cantidad} actas correctamente`;
    toast(`‚úÖ Se borraron ${cantidad} actas correctamente`);
    
    console.log(`Se borraron ${cantidad} actas del IndexedDB`);
    
  }catch(err){
    console.error('Error borrando actas:', err);
    $('#estadoDatos').textContent = `‚ùå Error borrando actas: ${err.message}`;
    toast('‚ùå Error borrando actas');
  }
}

function toast(msg){
  $('#estadoDatos').textContent = msg;
  setTimeout(() => {
    $('#estadoDatos').textContent = '';
  }, 3000);
}

// ===== REPORTE PDF =====
async function generarReportePDF(){
  try{
    toast('üìÑ Generando reporte PDF...');
    
    // Aqu√≠ podr√≠as implementar la generaci√≥n de PDF usando jsPDF
    // Por ahora, exportar a Excel
    const workbook = XLSX.utils.book_new();
    
    // Hoja de resumen
    const resumenData = [
      ['M√©trica', 'Valor'],
      ['Total Actas', state.data.filtrada.actas.length],
      ['Total Compromisos', state.data.filtrada.compromisos.length],
      ['Clientes √önicos', new Set(state.data.filtrada.actas.map(a => a.cliente_razon)).size],
      ['Promedio Compromisos/Acta', (state.data.filtrada.compromisos.length / state.data.filtrada.actas.length).toFixed(1)]
    ];
    
    const wsResumen = XLSX.utils.aoa_to_sheet(resumenData);
    XLSX.utils.book_append_sheet(workbook, wsResumen, 'Resumen');
    
    // Hoja de actas filtradas
    const wsActas = XLSX.utils.json_to_sheet(state.data.filtrada.actas);
    XLSX.utils.book_append_sheet(workbook, wsActas, 'Actas Filtradas');
    
    // Hoja de compromisos filtrados
    const wsCompromisos = XLSX.utils.json_to_sheet(state.data.filtrada.compromisos);
    XLSX.utils.book_append_sheet(workbook, wsCompromisos, 'Compromisos Filtrados');
    
    // Descargar
    const fecha = new Date().toISOString().split('T')[0];
    const filename = `Reporte_Acta_Express_${fecha}.xlsx`;
    XLSX.writeFile(workbook, filename);
    
    toast('‚úÖ Reporte descargado: ' + filename);
    
  }catch(err){
    console.error(err);
    toast('‚ùå Error generando reporte');
  }
}

# üöÄ Gu√≠a de Despliegue en GitHub Pages

## Pasos para publicar Acta Express como PWA

### 1Ô∏è‚É£ Crear repositorio en GitHub

```powershell
# Inicializar repositorio local (si a√∫n no est√° inicializado)
git init

# Agregar todos los archivos
git add .

# Commit inicial
git commit -m "feat: Initial commit - Acta Express PWA completa"

# Conectar con repositorio remoto (crea uno en github.com primero)
git remote add origin https://github.com/TU_USUARIO/acta-express.git

# Subir a GitHub
git branch -M main
git push -u origin main
```

### 2Ô∏è‚É£ Activar GitHub Pages

1. Ve a tu repositorio en GitHub
2. Settings ‚Üí Pages
3. Source: selecciona la rama `main` y carpeta `/ (root)`
4. Save
5. Espera 1-2 minutos

Tu app estar√° disponible en:
```
https://TU_USUARIO.github.io/acta-express/
```

### 3Ô∏è‚É£ Verificar PWA

1. Abre la URL en Chrome (m√≥vil o desktop)
2. DevTools ‚Üí Application ‚Üí Manifest (verificar que cargue)
3. DevTools ‚Üí Application ‚Üí Service Workers (verificar que est√© activo)
4. En Android: Chrome ‚Üí Men√∫ ‚Üí **Agregar a pantalla de inicio**

### 4Ô∏è‚É£ Actualizar despliegue

```powershell
# Hacer cambios en el c√≥digo
git add .
git commit -m "feat: Descripci√≥n del cambio"
git push origin main
```

GitHub Pages se actualizar√° autom√°ticamente en 1-2 minutos.

---

## ‚ö° Alternativas de despliegue

### Netlify (m√°s f√°cil)
1. Arrastra la carpeta del proyecto en [netlify.com/drop](https://app.netlify.com/drop)
2. HTTPS autom√°tico
3. URL tipo: `tu-proyecto.netlify.app`

### Vercel
```powershell
npx vercel
```

---

## ‚úÖ Checklist de PWA

- [ ] HTTPS activado (GitHub Pages lo hace autom√°tico)
- [ ] `manifest.webmanifest` enlazado en `index.html`
- [ ] Service Worker registrado en `app.js`
- [ ] √çconos 192x192 y 512x512 presentes
- [ ] Probado en Chrome m√≥vil
- [ ] Instalaci√≥n funciona correctamente
- [ ] Modo offline funciona (desconectar WiFi y probar)

---

## üêõ Soluci√≥n de problemas

### Service Worker no se activa
- Verifica que la URL sea HTTPS (o localhost)
- Abre DevTools ‚Üí Application ‚Üí Service Workers
- Click en "Unregister" y recarga
- Verifica la consola por errores

### PWA no se puede instalar
- Verifica que `manifest.webmanifest` tenga todos los campos
- √çconos deben existir y ser accesibles
- start_url debe apuntar correctamente

### Offline no funciona
- Verifica que el Service Worker est√© instalado
- Revisa las rutas en `ASSETS` del service-worker.js
- Prueba con "Application ‚Üí Cache Storage" en DevTools

---

**¬°Listo! Tu PWA Acta Express estar√° funcionando en producci√≥n.** üéâ

